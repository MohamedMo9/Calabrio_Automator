with data as( select convert(varchar,DATEADD(minute,TZ_VAL,activity_starttime),23) as DT, DATEADD(minute,TZ_VAL,activity_starttime) as StartTime, DATEADD(minute,TZ_VAL,activity_endtime) as EndTime, datediff(second ,activity_starttime,activity_endtime) as Duration,(case when dim_activity.activity_name like 'E %' then 'Emails' when dim_activity.activity_name like 'C %' then 'Chats' when dim_activity.activity_name like 'P %' and dim_activity.activity_name not like '%Callback' then 'Phones' else dim_activity.activity_name end) as 'ActivityType', dim_person.person_name name, dim_person.email EM, dim_person.team_name TEAM from mart.fact_schedule inner join mart.dim_person on fact_schedule.person_id = dim_person.person_id inner join mart.dim_activity on fact_schedule.activity_id = dim_activity.activity_id where scenario_id = 1 and dim_person.valid_to_date = (select max(valid_to_date) from mart.dim_person maxtable where dim_person.person_name = maxtable.person_name) and convert(varchar,DATEADD(minute,TZ_VAL,activity_starttime),23) between 'DATE_START' and 'DATE_END' group by team_name,activity_name, convert(varchar,DATEADD(minute,TZ_VAL,activity_starttime),23), dim_person.person_name, dim_person.email,activity_starttime, activity_endtime) select name, ActivityType, DT, left(CONVERT(VARCHAR(8),StartTime,108),5) as StartTime, left(CONVERT(VARCHAR(8),EndTime,108),5) as EndTime from data
